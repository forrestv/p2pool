machine:
  python:
    version: 2.7.9
general:
  branches:
    only:
      - circleci-testing
  artifacts:
    #- "coverage" # relative to the user's home directory
    - /home/ubuntu/.pip/pip.log
dependencies:
  pre:
    - sudo apt-add-repository ppa:bitcoin/bitcoin -y
    - sudo apt-get update -qq
    - sudo apt-get install -qq bitcoind
  override:
    - pip install -q -r requirements.txt
test:
  pre:
    # setup and launch bitcoind
    - mkdir /home/ubuntu/.bitcoin
    - cp test-data/bitcoin.conf /home/ubuntu/.bitcoin/.
    - chmod 600 /home/ubuntu/.bitcoin/bitcoin.conf
    - bitcoind --regtest --daemon:
        background: true
    - sleep 5
    - bitcoin-cli --regtest setgenerate true 10
    # Build litecoin
    - sudo python setup.py install && cp build/*/ltc_scrypt.so ../:
        pwd: litecoin_scrypt
    # launch p2pool to test against
    - python run_p2pool.py --disable-upnp --regtest --debug:
        background: true
    - sleep 10
    # generate more blocks so it is seen as new work
    - bitcoin-cli --regtest setgenerate true 10
  override:
    # Testing the bitcoins tests
    # These 3 pass
    ##- trial -e p2pool/test/bitcoin/test_data.py
    ##- trial -e p2pool/test/bitcoin/test_getwork.py
    ##- trial -e p2pool/test/bitcoin/test_p2p.py
    # These 2 don't
    ##- trial -e p2pool/test/bitcoin/test_scrypt.py
    ##- trial -e p2pool/test/bitcoin/test_sha265.py
    ## Testing p2pool tests
    # These 2 pass
    ##- trial -e p2pool/test/test_data.py
    ##- trial -e p2pool/test/test_node.py
    # This one hates me
    - trial -e p2pool/test/test_p2p.py
